 # MoodCloud / Whispers of Life - TodoList

## 核心功能是否合理（结论）

整体方向是合理的：

- **AI 识别 + 润色**：项目已有 `geminiService.refineThought`，只差“自动分类（牢骚/心得/轻语）”与“成本控制”。
- **多端发送/查看**：React/Vite 天然支持，关键在于移动端交互与输入体验。
- **想法云图**：当前 `ThoughtCloud` 直接渲染所有 thoughts，后续需要“抽样/分页/性能策略”。
- **评论/点赞/个人主页**：当前已有评论、点赞按钮、ProfileView，属于正确的增长路径。

需要补齐/收敛的关键点：

- **“免费 AI”不可完全保证**：需要明确策略（仅本地分类？仅对登录用户？每日限额？只做润色不做生成？）。
- **数据模型与权限需要对齐**：目前 schema 中 `thoughts.author_id` 引用 `users(id)`，但前端用的是 `supabase.auth.user.id`；若不对齐会造成插入失败或权限策略失效。
- **点赞去重与反作弊**：现在是 `likes + 1`，同一用户可无限点；需要 likes 表或去重策略。
- **RLS 策略需修正**：`comments` 表缺少 `author_id` 却写了 `auth.uid() = id`（不合理）。

## 核心功能（建议最终版）

1. **发布想法**：支持登录发布。
2. **AI 能力（可选）**：
   - 自动识别类型：牢骚（GRUMBLE）/心得（INSIGHT）/轻语（WHISPER）
   - 一键润色（refine）
3. **想法云图**：随机出现数据库中的想法（抽样 N 条），可刷新/换一批。
4. **互动**：评论、点赞、查看个人主页。
5. **账号与权限/隐私**：登录注册、只允许修改/删除自己的内容、内容基础审核（举报/屏蔽）。

---

## P0（MVP，可上线）

### 账号与数据打通

- [ ] **Supabase 环境变量配置**：`VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`、`GEMINI_API_KEY`
  - 验收：本地 `npm run dev` 可正常登录、读写 thoughts/comments。
- [ ] **统一用户 ID 方案（确定：A）**：`public.users.id = auth.uid()`
  - [ ] 调整 schema：`users.id` 不再使用 `gen_random_uuid()` 默认值（确保可以用 auth.uid 写入）
  - [ ] 新增触发器/函数：用户注册（`auth.users` 插入）时自动 `insert into public.users (id, username, avatar)`
  - [ ] 前端兜底 upsert：登录后如果 public.users 不存在则创建（避免触发器没配好导致后续外键失败）
  - 验收：新用户注册后，`public.users.id === auth.uid()`；发布 thought/comment 时 `author_id` 可写入且外键不报错。
- [ ] **修正 comments 表结构与 RLS（配合 A 方案）**
  - [ ] `comments` 表新增 `author_id uuid not null`
  - [ ] `comments` 表 INSERT 时写入 `author_id = auth.uid()`
  - [ ] 修正 policy：
    - SELECT：所有人可读（保留）
    - INSERT：仅 authenticated
    - UPDATE/DELETE：`auth.uid() = author_id`
  - 验收：A 用户不能编辑/删除 B 用户评论；未登录不能发评论。

- [ ] **匿名用户只读（产品决策）**
  - 规则：未登录用户只能浏览 thoughts/comments，不能发帖/评论/点赞
  - 验收：
    - 未登录时输入区不可提交（按钮禁用或弹登录弹窗）
    - 未登录时点赞按钮不可用（禁用或弹登录弹窗）
    - 仅登录用户可 INSERT thoughts/comments

### 时间安排（每周 3 晚 * 2 小时）

目标：**2 周完成 P0 上线**（约 12 小时），第 3-4 周进入 P1。

#### 第 1 周（打通数据与权限）

- [x] **第 1 晚（2h）**：Supabase 端准备
  - 产出：schema 按 A 方案调整（users.id、comments.author_id、RLS 修正草案）
  - 自测：在 Supabase SQL Editor 里能创建/更新 policy，不报错
- [x] **第 2 晚（2h）**：用户资料自动落库
  - 产出：`auth.users -> public.users` 触发器（或你选择用前端 upsert 方案也行，但建议两者都有）
  - 自测：新注册账号后 public.users 有对应行，id 与 auth.uid 一致
- [x] **第 3 晚（2h）**：前端写入 author_id & 读写闭环
  - 产出：发布 thought/comment 时写入 `author_id`；RLS 下可正常 insert/update/delete
  - 产出：作者可编辑/删除自己的 thought（详情弹窗 + 个人主页入口）；非作者不可见且 RLS 兜底
  - 产出：点赞改为 RPC 自增（匿名/非作者可点赞，不放开 thoughts 表 UPDATE）
  - 产出：点赞状态本地去重（未点赞不显示填充；同一浏览器防重复点赞）
  - 产出：输入法组合输入（IME composing）下 Enter 不误发送
  - 自测：登录用户可发帖/评论；不同账号互相不可改对方内容
  - 自测：作者可编辑/删除自己 thought；非作者看不到编辑/删除
  - 自测：匿名/非作者可点赞；刷新后点赞数与本地已点赞状态正确

#### 第 2 周（MVP 体验 + 上线）

- [x] **第 1 晚（2h）**：云图抽样 + 换一批
   - 产出：渲染时仅抽样 N 条（如 100）；加“换一批”按钮
   - 自测：数据库数据多时仍流畅

- [x] **第 2 晚（2h）**：错误处理/空态 + 基础打磨
   - 产出：加载失败提示、无数据空态、权限失败提示
  - 自测：断网/无权限时 UI 有明确反馈
- [x] **第 3 晚（2h）**：部署
  - 产出：Netlify 部署成功，环境变量配置完成
  - 自测：线上可登录、可发帖、可评论、可点赞（最小可用版）

#### 第 3-4 周（P1：把“核心卖点”做实）

- [x] **第 3 周**：AI 自动分类 + 成本控制
  - 产出：发帖时自动填 `ThoughtType`；无 Key/超限降级
- [x] **第 4 周**：点赞去重（likes 表）+ 删除自己的内容 + 个人主页增强
  - 产出：同一用户点赞不重复；可取消；可删除自己的 thought/comment

### 核心交互闭环

- [x] **发布想法（仅登录）**
  - 验收：未登录用户只能浏览；尝试发布会引导登录；登录后发布成功且云图立刻出现。
- [x] **查看想法详情 + 评论列表**
  - 验收：点击云图词条弹窗；可加载对应 comments。
- [x] **发表评论（仅登录）**
  - 验收：未登录输入框禁用；登录后可发布并实时出现。
- [x] **点赞（先做最小可用）**
  - 验收：仅登录可点赞；点赞数可增长并持久化；刷新后不丢失。

### 云图展示（最小策略）

- [x] **抽样展示 N 条（建议 N=200，可配置）**
  - 验收：数据库 1k+ 数据仍能流畅；不会一次渲染全量导致卡顿。
- [x] **“换一批/刷新云图”按钮**
  - 验收：点击后重新抽样并重新布局。

### 部署与可用性

- [x] **错误处理与空态**（加载失败、无数据、无权限）
  - 验收：网络/权限错误时有可读提示，不是静默失败。
- [x] **Netlify 部署**（或你现有平台）
  - 验收：生产环境可访问；环境变量正确配置；登录与数据库读写正常。

---

## P1（增强：AI 分类 + 真社交）

### AI 分类（核心卖点补齐）

- [x] **自动分类 ThoughtType（GRUMBLE/INSIGHT/WHISPER）**
  - 策略：前端调用 Gemini 生成 type；或后端/Edge Function 统一处理
  - 验收：发布内容后 type 自动填写；分类准确率可接受（人工抽检 50 条）。
- [x] **AI 成本控制**
  - 每日限额、仅登录用户可用、超限降级为本地规则分类
  - 验收：无 Key / 超配额时仍可发帖（只是不走 AI）。

### 点赞去重

- [x] **likes 表（thought_id + user_id 唯一约束）**
  - 验收：同一用户重复点赞不会无限加；可取消点赞。

### 内容管理

- [x] **删除自己的想法/评论**
  - 验收：只能删除自己内容；删除后 UI 立即更新。
- [x] **个人主页增强**
  - 显示 TA 的想法列表、被赞总数、加入时间
  - 验收：从想法作者入口可进入对方主页（不仅是“我的主页”）。

### 性能与体验

- [x] **分页/无限滚动**（thoughts/comments）
  - 验收：大量数据下仍可用，首屏加载稳定。
- [x] **云图布局优化**（避免重叠、移动端可拖拽/缩放 可选）

---

## P2（体验/运营）

- [ ] **搜索与筛选**（按类型、作者、关键词）
- [ ] **标签/话题**（#tag）
- [ ] **举报/屏蔽**（最小审核工具）
- [ ] **通知**（被评论/被点赞）
- [ ] **统计**（DAU、发帖数、评论数、AI 调用次数）
- [ ] **备份与数据迁移脚本**

---

## 已知风险与技术债（尽早处理）

- [ ] **前端直接使用 Gemini API Key 的风险**：建议迁移到 Serverless/Edge Function 以避免 Key 暴露。
- [ ] **Supabase RLS 与数据模型对齐**：先定“用户 ID 方案”，否则后续权限与社交功能会反复返工。

